/**
*
*   Asynchronous.js
*   @version: 0.4.2
*
*   Simple JavaScript class to manage asynchronous, parallel, linear, sequential and interleaved tasks
*   https://github.com/foo123/asynchronous.js
*
**/!function(n,e,t){"use strict";"object"==typeof module&&module.exports?module.exports=(module.deps=module.deps||{})[e]=module.deps[e]||t.call(n)||1:"function"==typeof define&&define.amd?define(e,[],function(){return t.call(n)}):e in n||(n[e]=t.call(n)||1)}(this,"Asynchronous",function(){var exports={};return!function(root,exports,undef){"use strict";function runParallelised(n){n.$runmode=PARALLELISED,n.$running=!1}function runLinearised(n,e){var t,r=n,o=r.$queue;if(r.$runmode=LINEARISED,o){for(;o.length&&(!o[0]||!o[0].canRun());)o.shift();o.length?(r.$running=!0,t=o.shift(),e?t.runWithArgs(e):t.run(),t.complete()):r.$running=!1}}function runInterleaved(n,e){var t,r=n,o=r.$queue,s=0;if(r.$runmode=INTERLEAVED,o&&o.length){for(r.$running=!0;s<o.length;)t=o[s],t&&t.canRun()?(e?t.runWithArgs(e):t.run(),t.isFinished()?(o.shift(),t.complete()):s++):o.shift();r.$running=!1,r.$timer=SetTime(curry(runInterleaved,r),r.$interval)}}function runSequenced(n,e){var t,r=n,o=r.$queue;r.$runmode=SEQUENCED,o&&o.length&&(t=o[0],t&&t.canRun()?(r.$running=!0,e?t.runWithArgs(e):t.run(),t.isFinished()&&(o.shift(),t.complete())):o.shift(),r.$running=!1,r.$timer=SetTime(curry(runSequenced,r),r.$interval))}var PROTO="prototype",Obj=Object,Arr=Array,Func=Function,FP=Func[PROTO],OP=Obj[PROTO],AP=Arr[PROTO],slice=FP.call.bind(AP.slice),toString=FP.call.bind(OP.toString),typeOf=function(n){return typeof n},isFunction=function(n){return"function"==typeof n},is_instance=function(n,e){return n instanceof e},SetTime=setTimeout,ClearTime=clearTimeout,UNDEFINED=undef,UNKNOWN=0,NODE=1,BROWSER=2,DEFAULT_INTERVAL=60,NONE=0,INTERLEAVED=1,LINEARISED=2,PARALLELISED=3,SEQUENCED=4,isNode="undefined"!=typeof global&&"[object global]"===toString(global),isNodeProcess=!(!isNode||!process.env.NODE_UNIQUE_ID),isBrowser=!isNode&&"undefined"!=typeof navigator,isWebWorker=isBrowser&&"function"==typeof importScripts&&is_instance(navigator,WorkerNavigator),supportsMultiThread=isNode||"function"==typeof Worker,isThread=isNodeProcess||isWebWorker,Thread,numProcessors=isNode?require("os").cpus().length:4,fromJSON=JSON.parse,toJSON=JSON.stringify,onMessage,curry=function(n,e){return function(){return n(e)}},URL=root.webkitURL||root.URL||null,blobURL=function(n,e){return URL?URL.createObjectURL(new Blob([n||""],{type:e||"text/javascript"})):n},path=function(){var n;return isNode?{file:__filename,path:__dirname}:isWebWorker?{file:n=self.location.href,path:n.split("/").slice(0,-1).join("/")}:isBrowser&&(n=document.getElementsByTagName("script"))&&n.length?{file:n=n[n.length-1].src,path:n.split("/").slice(0,-1).join("/")}:{path:null,file:null}},thisPath=path(),tpf=thisPath.file,notThisPath=function(n){return!(!n||!n.length||n===tpf)};if(onMessage=isWebWorker?function(n){n&&(onmessage=n)}:isNodeProcess?function(n){n&&process.on("message",function(e){n(fromJSON(e))})}:function(){},isNode){var fs=require("fs"),ps=require("child_process");root.close=function(){process.exit()},root.postMessage=function(n){process.send(toJSON({data:n}))},root.importScripts=function(scripts){if(scripts){scripts=scripts.split(",");for(var i=0,src,ok;i<scripts.length;){ok=!0;try{src=fs.readFileSync(scripts[i++]),eval(src)}catch(e){ok=e}if(!0!==ok)throw ok}}},Thread=function(n){var e=this;e.process=ps.fork(n),e.process.on("message",function(n){e.onmessage&&e.onmessage(fromJSON(n))}),e.process.on("error",function(n){e.onerror&&e.onerror(n)})},Thread[PROTO]={constructor:Thread,process:null,onmessage:null,onerror:null,postMessage:function(n){return this.process&&this.process.send(toJSON({data:n})),this},terminate:function(){return this.process&&(this.process.kill(),this.process=null),this}}}else Thread=root.Worker;var Task=function(n){if(n instanceof Task)return n;if(!(this instanceof Task))return new Task(n);1>arguments.length&&(n=null);var e=this,t=null,r=null,o=!1,s=!1,u=!1,i=!1,a=!1,l=!1,c=null,f=0,h=1,p=null,d=null,m=null,g=undef,E=function(){return g=n(e),o=!0,g};e.task=function(t){return n=t,e},e.queue=function(n){return arguments.length?(t=n,e):t},e.jumpNext=function(n){t&&t.jumpNext(!1,n)},e.abort=function(n){t&&(t.abort(!1),n&&(t.dispose(),t=null))},e.dispose=function(){t&&(t.dispose(),t=null)},e.canRun=function(){return n&&(!o||s||u||i||a||l)?(s||u)&&f>=p?!1:u&&!c?!1:(i||a)&&g===d?!1:!0:!1},e.run=E,e.runWithArgs=function(e){return g=n.apply(null,e),o=!0,g},e.iif=function(t,r,o){return t?n=r:arguments.length>2&&(n=o),e},e.until=function(n){return g=undef,c=null,d=n,a=!0,l=!1,s=!1,u=!1,i=!1,e.run=E,e},e.untilNot=function(n){return g=undef,c=null,m=n,l=!0,a=!1,s=!1,u=!1,i=!1,e.run=E,e},e.loop=function(t,r,d){return g=undef,c=null,f=r||0,h=d||1,p=t,s=!0,a=!1,l=!1,u=!1,i=!1,e.run=function(){var e;return e=n(f),f+=h,g=e,o=!0,e},e},e.each=function(t){return g=undef,c=t,f=0,h=1,p=t?t.length||0:0,u=!0,a=!1,l=!1,s=!1,i=!1,e.run=function(){var e;return e=n(c[f],f),f++,g=e,o=!0,e},e},e.recurse=function(t,r){return c=null,g=t,d=r,i=!0,a=!1,l=!1,s=!1,u=!1,e.run=function(){var e;return e=n(g),g=e,o=!0,e},e},e.isFinished=function(){var n=!o||l||a||s||u||i;return n&&(a||i)&&g===d&&(n=!1),n&&l&&g!==m&&(n=!1),n&&(s||u)&&f>=p&&(n=!1),!n},e.onComplete=function(n){return r=n||null,e},e.complete=function(){return r&&isFunction(r)&&r(),e}},Asynchronous=exports.Asynchronous=function(n,e){if(is_instance(n,Task))return n;if(isFunction(n))return new Task(n);if(!is_instance(this,Asynchronous))return new Asynchronous(n);var t=this;t.$interval=arguments.length?parseInt(n,10):DEFAULT_INTERVAL,t.$timer=null,t.$runmode=NONE,t.$running=!1,t.$queue=[],isThread&&!1!==e&&t.initThread()};if(Asynchronous.VERSION="0.4.2",Asynchronous.Thread=Thread,Asynchronous.Task=Task,Asynchronous.MODE={NONE:NONE,INTERLEAVE:INTERLEAVED,LINEAR:LINEARISED,PARALLEL:PARALLELISED,SEQUENCE:SEQUENCED},Asynchronous.Platform={UNDEFINED:UNDEFINED,UNKNOWN:UNKNOWN,NODE:NODE,BROWSER:BROWSER},Asynchronous.supportsMultiThreading=function(){return supportsMultiThread},Asynchronous.isPlatform=function(n){return NODE===n?isNode:BROWSER===n?isBrowser:undef},Asynchronous.isThread=function(n){return NODE===n?isNodeProcess:BROWSER===n?isWebWorker:isThread},Asynchronous.path=path,Asynchronous.blob=blobURL,Asynchronous.load=function(n,e,t){if(n){e&&e.length&&(e=e.filter(notThisPath),e.length&&importScripts(e.join(","))),n=n.split(".");for(var r=root;n.length;)n[0]&&n[0].length&&r[n[0]]&&(r=r[n[0]]),n.shift();if(r&&root!==r)return isFunction(r)?!1!==t?new r:r():r}return null},Asynchronous.serialize=function(n){n=n||new Asynchronous;var e=function(e){var t=function(){var t=this,r=slice(arguments);n.step(function(){e.apply(t,r)}),n.$running||n.run(LINEARISED)};return t.free=function(){return e},t};return e.free=function(){n&&n.dispose(),n=null},e},Asynchronous[PROTO]={constructor:Asynchronous,$interval:DEFAULT_INTERVAL,$timer:null,$queue:null,$thread:null,$events:null,$runmode:NONE,$running:!1,dispose:function(){var n=this;return n.unfork(),n.$timer&&ClearTime(n.$timer),n.$thread=null,n.$timer=null,n.$interval=null,n.$queue=null,n.$runmode=NONE,n.$running=!1,n},empty:function(){var n=this;return n.$timer&&ClearTime(n.$timer),n.$timer=null,n.$queue=[],n.$runmode=NONE,n.$running=!1,n},interval:function(n){return arguments.length?(this.$interval=parseInt(n,10),this):this.$interval},fork:function(n,e,t){var r,o,s,u=this;if(!u.$thread){if(!supportsMultiThread)throw u.$thread=null,new Error("Asynchronous: Multi-Threading is NOT supported!");isNode?(o="Asynchronous: Thread (Process): ",s="Asynchronous: Thread (Process) Error: "):(o="Asynchronous: Thread (Worker): ",s="Asynchronous: Thread (Worker) Error: "),u.$events=u.$events||{},r=u.$thread=new Thread(tpf),r.onmessage=function(n){if(n.data.event){var e=n.data.event,t=n.data.data||null;u.$events&&u.$events[e]?u.$events[e](t):("console.log"===e||"console.error"===e)&&console.log(o+(t.output||""))}},r.onerror=function(n){if(!u.$events||!u.$events.error)throw new Error(s+n.message+" file: "+n.filename+" line: "+n.lineno);u.$events.error(n)},u.send("initThread",{component:n||null,asInstance:!1!==t,imports:e?[].concat(e):null})}return u},unfork:function(){var n=this;return n.$thread&&n.send("dispose"),n.$thread=null,n.$events=null,n},initThread:function(){var n=this;return isThread&&(n.$events={},onMessage(function(e){var t=e.data.event,r=e.data.data||null;t&&n.$events[t]?n.$events[t](r):"dispose"===t&&(n.dispose(),close())})),n},listen:function(n,e){return n&&isFunction(e)&&this.$events&&(this.$events[n]=e),this},unlisten:function(n,e){return n&&this.$events&&this.$events[n]&&(2>arguments.length||e===this.$events[n])&&delete this.$events[n],this},send:function(n,e){return n&&(isThread?postMessage({event:n,data:e||null}):this.$thread&&this.$thread.postMessage({event:n,data:e||null})),this},task:function(n){return is_instance(n,Task)?n:isFunction(n)?Task(n):void 0},iif:function(){var n=slice(arguments),e=new Task;return e.iif.apply(e,n)},until:function(){var n=slice(arguments),e=new Task(n.pop());return e.until.apply(e,n)},untilNot:function(){var n=slice(arguments),e=new Task(n.pop());return e.untilNot.apply(e,n)},loop:function(){var n=slice(arguments),e=new Task(n.pop());return e.loop.apply(e,n)},each:function(){var n=slice(arguments),e=new Task(n.pop());return e.each.apply(e,n)},recurse:function(){var n=slice(arguments),e=new Task(n.pop());return e.recurse.apply(e,n)},step:function(n){var e=this;return n&&e.$queue.push(e.task(n).queue(e)),e},steps:function(){var n,e,t=this,r=slice(arguments);for(e=r.length,n=0;e>n;n++)t.step(r[n]);return t},jumpNext:function(n,e){var t=this,r=t.$queue;return e=e||0,!1!==n?function(){return e<r.length&&(e>0&&r.splice(0,e),t.run(t.$runmode)),t}:(e<r.length&&(e>0&&r.splice(0,e),t.run(t.$runmode)),t)},jumpNextWithArgs:function(n,e,t){var r=this,o=r.$queue;return e=e||0,!1!==n?function(){return e<o.length&&(e>0&&o.splice(0,e),r.run(r.$runmode,slice(arguments))),r}:(e<o.length&&(e>0&&o.splice(0,e),r.run(r.$runmode,t)),r)},abort:function(n,e){var t=this;return!1!==n?function(){return e&&e>0?SetTime(function(){t.empty()},e):t.empty(),t}:(e&&e>0?SetTime(function(){t.empty()},e):t.empty(),t)},run:function(n,e){var t=this;return arguments.length?t.$runmode=n:n=t.$runmode,e=e||null,SEQUENCED===n?runSequenced(t,e):INTERLEAVED===n?runInterleaved(t,e):LINEARISED===n?runLinearised(t,e):PARALLELISED===n&&runParallelised(t,e),t}},isThread){var Component=null;root.console={log:function(n){postMessage({event:"console.log",data:{output:n||""}})},error:function(n){postMessage({event:"console.error",data:{output:n||""}})}},onMessage(function(n){var e=n.data.event,t=n.data.data||null;switch(e){case"initThread":t&&t.component&&(Component&&(isFunction(Component.dispose)&&Component.dispose(),Component=null),Component=Asynchronous.load(t.component,t.imports,t.asInstance));break;case"dispose":default:Component&&(isFunction(Component.dispose)&&Component.dispose(),Component=null),close()}})}}(this,exports),exports.Asynchronous});